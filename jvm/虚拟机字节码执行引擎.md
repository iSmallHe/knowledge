# 虚拟机字节码执行引擎
## 1  运行时栈帧结构
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;栈帧时用于支持虚拟机进行方法调用和方法执行的数据结构，它是虚拟机运行时数据区中的虚拟机栈的栈元素。栈帧中存储了方法的局部变量表，操作数栈，动态连接，方法返回地址等信息。每一个方法从调用开始到执行完成，都对应着一个栈帧在虚拟机栈中从入栈到出站的过程。
### 1.1  局部变量表
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;局部变量表是一组变量值存储空间，用于存放方法参数和方法内部定义的局部变量。在java程序编译为Class文件时，就在方法的Code属性的max_locals数据项中确定了该方法所需分配的局部变量表的最大容量。  
        方法执行时，虚拟机时使用局部变量表完成参数值到参数变量表的传递过程的，如果执行的是实例方法，那局部变量表的第0位索引slot默认是用于传递方法所属对象实例的引用，在方法中可以用关键字“this”来访问这个隐含的参数。其余参数则按照参数表顺序排列。

### 1.2  操作数栈
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;操作数栈是一个后入先出栈。操作数栈的最大深度在编译的时候写入到Code属性的max_stacks数据项中。操作数栈的每一个元素可以是任意的java数据类型，包括long和double。32位数据类型所占的栈容量为1，64位数据类型所占的栈容量为2。
    当一个方法开始执行的时候，这个方法的操作数栈是空的，在方法的执行过程中，会有各种字节码指令往操作数栈中写入和提取，也就是入栈，出栈。例如：做算数运算时就是通过操作数栈进行的。

### 1.3  动态连接
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;每个栈帧都包含一个执行运行时常量池中该栈帧所属方法的引用，持有这个引用时为了支持方法调用过程中的动态链接。Class文件的常量池中存有大量的符号引用，字节码中的方法调用指令就以常量池中指向方法的符号引用作为参数。这些符号引用一部分会在类加载阶段或者第一次使用的时候就转化为直接引用，这种转化称为静态解析。另外一部分将在每一次运行期间转化为直接引用，这部分称为动态连接。  
  
### 1.4  方法返回地址
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当一个方法开始执行后，只有两种方式可以退出这个方法。第一种就是执行引擎遇到一个方法返回的字节码指令，这时候可能会有返回值传递个上层方法调用者，是否有返回值和返回值的类型将根据遇到何种方法返回指令来决定，这种退出方式称为正常完成出口。  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另一种就是遇到异常，并且这个异常在方法体内无法处理，这种将导致方法退出，称为异常完成出口。这种方式不会给上层调用者返回值。  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;方法退出的过程实际上就等同于当前栈帧出栈，因此退出时可能执行的操作有：恢复上层方法的局部变量表和操作数栈，把返回值压入调用者栈帧的操作数栈中，调整pc激素其的值，指向方法调用指令后面的一条指令。

## 2  解析和分派
### 2.1 解析
所有方法调用中的目标方法在Class文件中都是一个常量池中的符号引用，在类加载的解析阶段，会将其中一部分符号引用转化为直接引用，这种解析的成立前提：方法在程序真正运行之前就有一个确定的调用版本，并且这个方法的调用版本在运行期时不可变的。
Java虚拟机里面提供了5种方法调用字节码指令：  

1. invokestatic：调用静态方法
2. invokespecial：调用是咧构造器方法，私有方法和父类方法
3. invokevirtual：调用所有的虚方法
4. invokeinterface：调用接口方法，会在运行时再确定一个实现此接口的对象。
5. invokedynamic：先在运行时动态解析出调用点限定符所引用的方法，然后再执行该方法，在此之前的4条调用指令，分派逻辑是固化再java虚拟机内部的，而invokedynamic指令的分派逻辑是由用户所设定的引导方法决定的。  

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;只要能被invokestatic和invokespecial指令调用的方法，都可以在解析阶段中确定唯一的调用版本，符合这个条件的有静态方法，私有方法，实例构造器，父类方法4类，它们再类加载的时候就会把符号引用解析为该方法的直接引用。这些方法可以称为非虚方法，与之相反，其他方法称为虚方法（除去final方法）。  
### 2.2  分派
java是一种静态多分派，动态单分派的语言。